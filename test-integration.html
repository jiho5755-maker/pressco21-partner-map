<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒŒíŠ¸ë„ˆë§µ v3 - í†µí•© í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        h1 {
            color: #333;
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .test-result {
            font-weight: bold;
        }
        .success {
            color: #4CAF50;
        }
        .error {
            color: #f44336;
        }
        .info {
            color: #2196F3;
        }
        #test-log {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª íŒŒíŠ¸ë„ˆë§µ v3 - í†µí•© í…ŒìŠ¤íŠ¸</h1>

    <div class="test-section">
        <h2>ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
        <div id="test-results">
            <p class="info">í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...</p>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ ìƒì„¸ ë¡œê·¸</h2>
        <div id="test-log"></div>
    </div>

    <!-- ì„¤ì • ë° API -->
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>

    <script>
        // ì½˜ì†” ë¡œê·¸ ìº¡ì²˜
        var originalLog = console.log;
        var originalError = console.error;
        var logContainer = document.getElementById('test-log');

        function addLog(message, type) {
            var entry = document.createElement('div');
            entry.className = 'log-entry ' + (type || 'info');
            entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        console.log = function() {
            originalLog.apply(console, arguments);
            addLog(Array.from(arguments).join(' '), 'info');
        };

        console.error = function() {
            originalError.apply(console, arguments);
            addLog('ERROR: ' + Array.from(arguments).join(' '), 'error');
        };

        // í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        async function runTests() {
            var resultsContainer = document.getElementById('test-results');
            var results = [];

            try {
                // 1. Config ê²€ì¦
                addLog('=== í…ŒìŠ¤íŠ¸ ì‹œì‘ ===', 'info');
                addLog('1. Config ê²€ì¦ ì¤‘...', 'info');

                if (window.CONFIG && window.CONFIG.useTestData) {
                    results.push('âœ… Config ë¡œë“œ ì„±ê³µ (í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ' + window.CONFIG.useTestData + ')');
                    addLog('Config ë¡œë“œ ì„±ê³µ', 'success');
                } else {
                    results.push('âŒ Config ë¡œë“œ ì‹¤íŒ¨');
                    addLog('Config ë¡œë“œ ì‹¤íŒ¨', 'error');
                    throw new Error('Config ì—†ìŒ');
                }

                // 2. PartnerAPI ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
                addLog('2. PartnerAPI ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì¤‘...', 'info');
                var api = new window.PartnerAPI(window.CONFIG);
                results.push('âœ… PartnerAPI ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì„±ê³µ');
                addLog('PartnerAPI ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì„±ê³µ', 'success');

                // 3. íŒŒíŠ¸ë„ˆ ë°ì´í„° ë¡œë“œ
                addLog('3. íŒŒíŠ¸ë„ˆ ë°ì´í„° ë¡œë“œ ì¤‘...', 'info');
                var partners = await api.loadPartnerData(true);  // ê°•ì œ ìƒˆë¡œê³ ì¹¨

                if (partners && partners.length > 0) {
                    results.push('âœ… íŒŒíŠ¸ë„ˆ ë°ì´í„° ë¡œë“œ ì„±ê³µ (' + partners.length + 'ê°œ)');
                    addLog('íŒŒíŠ¸ë„ˆ ë°ì´í„° ë¡œë“œ ì„±ê³µ: ' + partners.length + 'ê°œ', 'success');
                } else {
                    results.push('âŒ íŒŒíŠ¸ë„ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (ë°ì´í„° ì—†ìŒ)');
                    addLog('íŒŒíŠ¸ë„ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
                    throw new Error('ë°ì´í„° ì—†ìŒ');
                }

                // 4. í•„ë“œëª… ê²€ì¦ (latitude/longitude)
                addLog('4. í•„ë“œëª… ê²€ì¦ ì¤‘...', 'info');
                var firstPartner = partners[0];
                var hasLatitude = 'latitude' in firstPartner;
                var hasLongitude = 'longitude' in firstPartner;

                if (hasLatitude && hasLongitude) {
                    results.push('âœ… í•„ë“œëª… í†µì¼ ì„±ê³µ (latitude/longitude ì‚¬ìš©)');
                    addLog('í•„ë“œëª… ê²€ì¦ ì„±ê³µ: latitude=' + firstPartner.latitude + ', longitude=' + firstPartner.longitude, 'success');
                } else {
                    results.push('âŒ í•„ë“œëª… ë¶ˆì¼ì¹˜ (latitude: ' + hasLatitude + ', longitude: ' + hasLongitude + ')');
                    addLog('í•„ë“œëª… ê²€ì¦ ì‹¤íŒ¨', 'error');
                }

                // 5. ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
                addLog('5. ë°ì´í„° ìœ íš¨ì„± ê²€ì¦ ì¤‘...', 'info');
                var validCount = 0;
                var invalidCount = 0;

                partners.forEach(function(p) {
                    if (p.id && p.name && p.latitude && p.longitude) {
                        validCount++;
                    } else {
                        invalidCount++;
                        addLog('ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°: ' + JSON.stringify(p), 'error');
                    }
                });

                results.push('âœ… ìœ íš¨í•œ ë°ì´í„°: ' + validCount + 'ê°œ');
                if (invalidCount > 0) {
                    results.push('âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°: ' + invalidCount + 'ê°œ');
                }

                // 6. ì§€ì—­ë³„ ë¶„í¬ í™•ì¸
                addLog('6. ì§€ì—­ë³„ ë¶„í¬ í™•ì¸ ì¤‘...', 'info');
                var regionCount = {};
                partners.forEach(function(p) {
                    var region = p.address.split(' ')[0].replace('íŠ¹ë³„ì‹œ', '').replace('ê´‘ì—­ì‹œ', '').replace('ë„', '');
                    regionCount[region] = (regionCount[region] || 0) + 1;
                });

                var regionSummary = Object.keys(regionCount).sort().map(function(r) {
                    return r + ': ' + regionCount[r] + 'ê°œ';
                }).join(', ');

                results.push('ğŸ“Š ì§€ì—­ ë¶„í¬: ' + regionSummary);
                addLog('ì§€ì—­ ë¶„í¬: ' + regionSummary, 'info');

                // 7. ì¹´í…Œê³ ë¦¬ë³„ ë¶„í¬ í™•ì¸
                addLog('7. ì¹´í…Œê³ ë¦¬ë³„ ë¶„í¬ í™•ì¸ ì¤‘...', 'info');
                var categoryCount = {};
                partners.forEach(function(p) {
                    if (Array.isArray(p.category)) {
                        p.category.forEach(function(cat) {
                            categoryCount[cat] = (categoryCount[cat] || 0) + 1;
                        });
                    }
                });

                var categorySummary = Object.keys(categoryCount).sort().map(function(c) {
                    return c + ': ' + categoryCount[c] + 'ê°œ';
                }).join(', ');

                results.push('ğŸ“Š ì¹´í…Œê³ ë¦¬ ë¶„í¬: ' + categorySummary);
                addLog('ì¹´í…Œê³ ë¦¬ ë¶„í¬: ' + categorySummary, 'info');

                // í…ŒìŠ¤íŠ¸ ì„±ê³µ
                results.push('');
                results.push('ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!');
                addLog('=== í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===', 'success');

            } catch (error) {
                results.push('');
                results.push('âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
                addLog('í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
                console.error(error);
            }

            // ê²°ê³¼ í‘œì‹œ
            resultsContainer.innerHTML = results.map(function(r) {
                var className = 'info';
                if (r.startsWith('âœ…')) className = 'success';
                if (r.startsWith('âŒ') || r.startsWith('âš ï¸')) className = 'error';

                return '<p class="test-result ' + className + '">' + r + '</p>';
            }).join('');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        window.addEventListener('load', function() {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>
